# Мультиплеерная игра Set для Telegram

Документация по созданию real-time мультиплеерной версии настольной игры "Set" для двух игроков в виде Telegram Mini App.

Основная архитектурная цель — минимизировать или полностью исключить серверную логику игры, перенеся её на сторону клиентов (P2P).

## 1. Основная идея

Создать веб-приложение (Telegram Mini App), в котором два игрока могут в реальном времени играть в "Set". Игровое поле, состоящее из 12 карт, синхронизировано между игроками. Когда один из игроков находит "сет", он нажимает на три карты. Если сет верный, игрок получает очко, карты заменяются новыми, и это изменение мгновенно отражается у второго игрока.

## 2. Ключевые особенности

- **Платформа:** Telegram Mini App (веб-приложение на HTML/CSS/JS).
- **Игроки:** 2.
- **Режим:** Real-time.
- **"Без сервера":** Игровая логика и синхронизация состояния происходят напрямую между двумя клиентами (Peer-to-Peer). Сервер используется только для "знакомства" клиентов (сигналинга).

## 3. Технологический стек

- **Фронтенд:** HTML, CSS, JavaScript (можно использовать легковесные фреймворки типа Vue.js или React, но для простоты достаточно нативного JS).
- **Интеграция с Telegram:** [Telegram Web App API](https://core.telegram.org/bots/webapps) для получения информации о пользователе и взаимодействия с клиентом Telegram.
- **P2P Связь:** **WebRTC**. Эта технология позволяет браузерам устанавливать прямое соединение друг с другом для обмена данными без постоянного участия сервера.
- **Сигнальный сервер:** Минимальный сервер на Node.js + WebSocket (или любой другой простой WebSocket-сервер), необходимый для первоначального обмена метаданными WebRTC (SDP и ICE candidates) между игроками. **Этот сервер не обрабатывает игровую логику.**

## 4. Логика игры "Set"

- **Колода:** 81 уникальная карта.
- **Атрибуты карты:** Каждая карта имеет 4 атрибута:
    1.  **Цвет:** Красный, Зеленый, Фиолетовый.
    2.  **Форма:** Ромб, Волна, Овал.
    3.  **Количество:** Один, Два, Три.
    4.  **Заливка:** Сплошная, Полосатая, Пустая.
- **"Сет":** Это набор из 3 карт, у которых каждый из 4-х атрибутов либо **полностью совпадает** у всех трех карт, либо **полностью различается**.
- **Игровой процесс:**
    1.  На стол выкладывается 12 карт.
    2.  Игроки одновременно ищут сет.
    3.  Первый, кто нашел, выбирает 3 карты.
    4.  Если сет верный, игрок получает очко, карты убираются, и на их место кладутся 3 новые из колоды.
    5.  Игра заканчивается, когда в колоде не осталось карт и на столе больше нет сетов.

## 5. Архитектура P2P

Поскольку центрального игрового сервера нет, один из игроков должен выполнять роль "хоста" сессии.

**Схема взаимодействия:**

1.  **Инициация игры:**
    -   Игрок 1 открывает приложение в Telegram. Он становится **Хостом**.
    -   Приложение генерирует уникальную ссылку для приглашения (например, `t.me/your_bot/set_game?startapp=game_id_123`).
    -   Игрок 1 делится этой ссылкой с Игроком 2.

2.  **Соединение (WebRTC Signaling):**
    -   Игрок 2 открывает ссылку. Его клиент (приложение) подключается к **сигнальному серверу**.
    -   Клиент Игрока 2 сообщает серверу, что он хочет присоединиться к `game_id_123`.
    -   Сигнальный сервер пересылает это сообщение Игроку 1 (который уже слушает этот `game_id`).
    -   Далее происходит стандартный процесс установки WebRTC-соединения (обмен "offer", "answer" и "ICE candidates") через сигнальный сервер.
    -   Как только соединение установлено, сигнальный сервер больше не нужен для этой игровой сессии. Вся коммуникация идет напрямую.

3.  **Синхронизация состояния:**
    -   **Хост (Игрок 1)** является "источником правды". Он генерирует колоду, перемешивает её и выкладывает первые 12 карт.
    -   Хост отправляет начальное состояние игры (карты на столе, оставшееся количество карт в колоде) Игроку 2 через прямое P2P-соединение.
    -   Когда любой из игроков (например, Игрок 2) считает, что нашел сет, он отправляет сообщение **Хосту** с индексами трех выбранных карт.
    -   **Хост** проверяет, является ли это сетом.
        -   **Если да:** Хост обновляет свое состояние (увеличивает счет Игрока 2, заменяет карты), а затем рассылает новое, актуальное состояние всем участникам (в данном случае, Игроку 2).
        -   **Если нет:** Хост отправляет сообщение об ошибке только Игроку 2.

**Типы P2P сообщений:**

-   `GAME_STATE_UPDATE`: Отправляется хостом, содержит полный срез состояния игры (карты на столе, счет, и т.д.).
-   `SELECT_CARDS`: Отправляется любым игроком хосту при попытке составить сет.
-   `INVALID_SET`: Отправляется хостом в ответ на `SELECT_CARDS`, если сет неверный.
-   `GAME_OVER`: Отправляется хостом, когда игра окончена.

## 6. План разработки

1.  **Настройка окружения:**
    -   Создать бота в Telegram через `@BotFather`.
    -   Включить режим "Inline Mode" и настроить "WebApp" для бота.
    -   Развернуть статические файлы (HTML, CSS, JS) на хостинге (например, GitHub Pages).
    -   Развернуть минимальный сигнальный WebSocket-сервер (например, на Heroku, Glitch, или любой VDS).

2.  **Frontend (WebApp):**
    -   Создать верстку игрового поля.
    -   Реализовать логику генерации колоды и проверки сетов на JavaScript.
    -   Написать код для отрисовки карт на столе.
    -   Реализовать обработчики кликов по картам.

3.  **Сетевая часть:**
    -   Написать клиентский код для взаимодействия с сигнальным сервером (подключение, отправка/получение сообщений).
    -   Реализовать логику установки WebRTC `RTCPeerConnection` и `RTCDataChannel`.
    -   Определить и реализовать протокол обмена сообщениями между пирами (JSON-объекты).

4.  **Интеграция:**
    -   Соединить игровую логику с сетевой частью. Действия игрока должны вызывать отправку P2P-сообщений, а получение сообщений — обновлять UI.

## 7. Возможные улучшения

-   **Режим на 3+ игроков:** Архитектура с хостом легко масштабируется. Хост просто будет рассылать обновления состояния всем подключенным пирам.
-   **Переподключение:** Реализовать логику переподключения к игре, если у одного из игроков оборвалась связь.
-   **Анимации:** Добавить плавные анимации для появления и исчезновения карт.
